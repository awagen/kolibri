version: '3.5'

networks:
  kolibri-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.33.0.0/16

services:

  prometheus:
    image: prom/prometheus:v2.28.1
    ports:
      - 9000:9090
    volumes:
      - ./prometheus:/etc/prometheus
      # /prometheus is the default data dir
      - ./prometheus/data:/prometheus
    networks:
      kolibri-net:
        ipv4_address: 172.33.1.5
    command: --web.enable-lifecycle  --config.file=/etc/prometheus/prometheus.yaml

  grafana:
    image: grafana/grafana:8.0.5
    volumes:
      - ./grafana:/var/lib/grafana
    ports:
      - 3000:3000
    # user setting needed to be set to owner/group of the volume (above grafana folder on host machine)
    user: "1000:1000"
    networks:
      kolibri-net:
        ipv4_address: 172.33.1.6

  kolibri1:
    image: kolibri-base:0.1.0-alpha3
    ports:
      - "8000:8000"
      - "5266:5266"
      - "9095:9095"
    environment:
      JVM_OPTS: >
        -XX:+PrintFlagsFinal
        -XX:+UseG1GC
        -Xms1024m
        -Xmx4096m
      PROFILE: prod
      ROLES: httpserver
      CLUSTER_NODE_HOST: 172.33.1.1
      CLUSTER_NODE_PORT: 8001
      HTTP_SERVER_INTERFACE: 172.33.1.1
      HTTP_SERVER_PORT: 8000
      MANAGEMENT_HOST: 172.33.1.1
      MANAGEMENT_PORT: 8558
      MANAGEMENT_BIND_HOSTNAME: '0.0.0.0'
      MANAGEMENT_BIND_PORT: 8558
      CLUSTER_NODE_BIND_HOST: '0.0.0.0'
      CLUSTER_NODE_BIND_PORT: 8001
      DISCOVERY_SERVICE_NAME: kolibri-service
      KOLIBRI_ACTOR_SYSTEM_NAME: KolibriAppSystem
      DISCOVERY_METHOD: config
    volumes:
      - ./kolibri-test:/app/data
    networks:
      kolibri-net:
        ipv4_address: 172.33.1.1
    mem_limit: 4200m

  kolibri2:
    image: kolibri-base:0.1.0-alpha3
    environment:
      JVM_OPTS: >
        -XX:+PrintFlagsFinal
        -XX:+UseG1GC
        -Xms1024m
        -Xmx4096m
      PROFILE: prod
      ROLES: compute
      CLUSTER_NODE_HOST: 172.33.1.2
      CLUSTER_NODE_PORT: 8001
      MANAGEMENT_HOST: 172.33.1.2
      MANAGEMENT_PORT: 8559
      MANAGEMENT_BIND_HOSTNAME: '0.0.0.0'
      MANAGEMENT_BIND_PORT: 8559
      CLUSTER_NODE_BIND_HOST: '0.0.0.0'
      CLUSTER_NODE_BIND_PORT: 8001
      DISCOVERY_SERVICE_NAME: kolibri-service
      KOLIBRI_ACTOR_SYSTEM_NAME: KolibriAppSystem
      DISCOVERY_METHOD: config
    volumes:
      - ./kolibri-test:/app/data
    networks:
      kolibri-net:
        ipv4_address: 172.33.1.2
    mem_limit: 4200m


  kolibri3:
    image: kolibri-base:0.1.0-alpha3
    environment:
      JVM_OPTS: >
        -XX:+PrintFlagsFinal
        -XX:+UseG1GC
        -Xms1024m
        -Xmx4069m
      PROFILE: prod
      ROLES: compute
      CLUSTER_NODE_HOST: 172.33.1.3
      CLUSTER_NODE_PORT: 8001
      MANAGEMENT_HOST: 172.33.1.3
      MANAGEMENT_PORT: 8560
      MANAGEMENT_BIND_HOSTNAME: '0.0.0.0'
      MANAGEMENT_BIND_PORT: 8560
      CLUSTER_NODE_BIND_HOST: '0.0.0.0'
      CLUSTER_NODE_BIND_PORT: 8001
      DISCOVERY_SERVICE_NAME: kolibri-service
      KOLIBRI_ACTOR_SYSTEM_NAME: KolibriAppSystem
      DISCOVERY_METHOD: config
    volumes:
      - ./kolibri-test:/app/data
    networks:
      kolibri-net:
        ipv4_address: 172.33.1.3
    mem_limit: 4200m
